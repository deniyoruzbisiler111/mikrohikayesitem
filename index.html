<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Şiir Uygulaması</title>
    
    <!-- Google Fonts: Patrick Hand -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #c4b497;
            margin: 0;
            padding: 0;
            font-family: 'Patrick Hand', cursive;
            transition: background-color 1.5s ease;
        }
        #poem-container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            height: 50vh;
            max-width: 90%;
            margin: 20px auto;
            line-height: 1.6;
            padding: 15px 5%;
            box-sizing: border-box;
        }
        #poem {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            white-space: pre-line;
            text-align: center;
            overflow-wrap: break-word;
            overflow: hidden;
            transition: opacity 0.8s ease-in-out;
            opacity: 0;
            width: 100%;
        }
        #poem.visible { opacity: 1; }
        #poem-button {
            padding: 0;
            border: none;
            background: transparent;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 12vw;
            max-width: 60px;
            height: 12vw;
            max-height: 60px;
            position: relative;
            transition: opacity 0.3s, transform 0.2s;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            border-radius: 50%;
        }
        #poem-button.first-time {
            border: 2px solid #888;
            background-color: rgba(200, 200, 200, 0.3);
        }
        #poem-button:hover { opacity: 0.8; transform: scale(1.1); }
        #poem-button:disabled { opacity: 0.5; pointer-events: none; }
        .hourglass {
            display: block;
            width: 100%;
            height: 100%;
            position: relative;
        }
        .hourglass:before {
            content: "⧖";
            font-size: 22px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: inline-block;
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
        }
        .spin .hourglass:before { 
            animation: spin 1s linear 2;
        }
        @keyframes spin { 
            0% { transform: translate(-50%, -50%) rotate(0deg); } 
            100% { transform: translate(-50%, -50%) rotate(360deg); } 
        }
        @media screen and (max-width: 400px) {
            #poem-container { padding: 10px 3%; height: 55vh; }
            #poem-button { width: 15vw; height: 15vw; }
        }
    </style>
</head>
<body>
    <div id="poem-container">
        <div id="poem"></div>
        <button id="poem-button">
            <span class="hourglass"></span>
        </button>
    </div>

    <script>
        const poemEl = document.getElementById("poem");
        const btn = document.getElementById("poem-button");
        const hourglass = document.querySelector('.hourglass');
        const body = document.body;

        const originalColor = "#c4b497";
        let hasClickedBefore = false;

        let allFiles = [];
        let fileOrder = [];
        let currentFileIndex = 0;
        let poemsInFile = [];
        let currentPoemIndex = 0;

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function adjustFontSize(text) {
            const maxFontSize = 24, minFontSize = 10;
            const tester = document.createElement('span');
            tester.style.visibility = 'hidden';
            tester.style.position = 'absolute';
            tester.style.whiteSpace = 'pre-line';
            tester.style.fontFamily = "'Patrick Hand', cursive";
            document.body.appendChild(tester);

            let fontSize = maxFontSize;
            const containerWidth = poemEl.clientWidth;
            const containerHeight = poemEl.clientHeight;
            const lines = text.split('\n');

            while (fontSize >= minFontSize) {
                tester.style.fontSize = fontSize + 'px';
                tester.innerText = text;

                const lineHeight = fontSize * 1.6;
                const totalHeight = lineHeight * lines.length;

                let maxLineWidth = 0;
                for (const line of lines) {
                    tester.innerText = line;
                    if (tester.scrollWidth > maxLineWidth) {
                        maxLineWidth = tester.scrollWidth;
                    }
                }
                if (maxLineWidth <= containerWidth && totalHeight <= containerHeight) break;
                fontSize--;
            }
            poemEl.style.fontSize = fontSize + 'px';
            document.body.removeChild(tester);
        }

        function randomSandColor() {
            const palette = [
                [196, 180, 151], [186, 167, 129], [206, 189, 163],
                [176, 160, 139], [216, 199, 171], [166, 150, 119]
            ];
            const base = palette[Math.floor(Math.random() * palette.length)];
            const variation = 10;
            const r = Math.min(255, Math.max(140, base[0] + (Math.random() * variation * 2 - variation)));
            const g = Math.min(255, Math.max(120, base[1] + (Math.random() * variation * 2 - variation)));
            const b = Math.min(255, Math.max(100, base[2] + (Math.random() * variation * 2 - variation)));
            return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
        }

        async function loadIndex() {
            const res = await fetch("poems/index.json");
            allFiles = await res.json();
            resetFileOrder();
            await loadNextFile();
            showPoem();
        }
        function resetFileOrder() {
            fileOrder = shuffle([...allFiles]);
            currentFileIndex = 0;
        }
        async function loadNextFile() {
            if (currentFileIndex >= fileOrder.length) resetFileOrder();
            const fileName = fileOrder[currentFileIndex];
            const res = await fetch("poems/" + fileName);
            const data = await res.json();
            poemsInFile = shuffle(data.poems);
            currentPoemIndex = 0;
            currentFileIndex++;
        }
        function showPoem() {
            if (currentPoemIndex >= poemsInFile.length) {
                loadNextFile().then(showPoem);
                return;
            }
            const poemText = poemsInFile[currentPoemIndex];
            adjustFontSize(poemText);
            poemEl.innerText = poemText;
            setTimeout(() => poemEl.classList.add("visible"), 100);
        }

        btn.addEventListener("click", async () => {
            if (btn.disabled) return;
            btn.disabled = true;
            
            // İlk tıklamada border ve arka planı kaldır
            if (!hasClickedBefore) {
                btn.classList.remove("first-time");
                hasClickedBefore = true;
            }
            
            btn.classList.add("spin");
            const newColor = randomSandColor();
            body.style.backgroundColor = newColor;
            poemEl.classList.remove("visible");
            await sleep(2000);
            currentPoemIndex++;
            showPoem();
            await sleep(500); // Şiir görünür olduktan sonra biraz bekle
            body.style.backgroundColor = originalColor;
            btn.disabled = false;
            btn.classList.remove("spin");
        });

        window.onload = () => { 
            // İlk daire border'ı göster
            btn.classList.add("first-time");
            loadIndex(); 
        };
    </script>
</body>
</html>
