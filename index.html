<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Şiir Uygulaması</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: hsl(40, 30%, 85%); /* başlangıç kum rengi */
      margin: 0;
      padding: 0;
      font-family: 'Patrick Hand', cursive;
      transition: background-color 0.3s linear;
    }

    #poem-container {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      height: 50vh;
      max-width: 90%;
      margin: 20px auto;
      line-height: 1.6;
      padding: 15px 5%;
      box-sizing: border-box;
    }

    #poem {
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      white-space: pre-line;
      text-align: center;
      overflow-wrap: break-word;
      overflow: hidden;
      transition: opacity 0.8s ease-in-out;
      opacity: 0;
      width: 100%;
    }

    #poem.visible {
      opacity: 1;
    }

    #poem-button {
      padding: 0;
      border: none;
      background: transparent;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      width: 12vw;
      max-width: 60px;
      height: 12vw;
      max-height: 60px;
      position: relative;
      transition: opacity 0.3s, transform 0.2s;
      outline: none;
      -webkit-tap-highlight-color: transparent; /* mobilde mavi kareyi kaldır */
      user-select: none; /* mobilde metin seçimi engelle */
    }

    #poem-button:hover:not(:disabled) {
      opacity: 0.8;
      transform: scale(1.1);
    }

    .hourglass {
      display: block;
      width: 100%;
      height: 100%;
      position: relative;
    }

    .hourglass:before {
      content: "⧖";
      font-size: 22px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .spin {
      animation: spin 1s linear 2;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="poem-container">
    <div id="poem"></div>
    <button id="poem-button">
      <span class="hourglass"></span>
    </button>
  </div>

  <script>
    const poems = [
      `Günah fısıldar\nVicdan susar\nRabbin görür`,
      `Gece karanlık.\nKalbim daha karanlık.\nBir tek secde ışık veriyor.`,
      `Yaşlı adam mezara baktı.\nGülümsedi: "Yıllardır bekleyen evime kavuştum."`,
      `mezarlık sessiz\nher taş sessizce haykırıyor\ndönüşe hazırlan diyor`,
      `'Yarın' dedi, tövbe için.\nAzrail 'bugün' dedi.`
    ];

    const poemEl = document.getElementById("poem");
    const btn = document.getElementById("poem-button");
    const hourglass = document.querySelector('.hourglass');
    const body = document.body;

    let shuffledPoems = [];
    let currentIndex = 0;

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function shuffleArray(array) {
      let shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function adjustFontSize(text) {
      const maxFontSize = 24;
      const minFontSize = 10;
      const tester = document.createElement('span');
      tester.style.visibility = 'hidden';
      tester.style.position = 'absolute';
      tester.style.whiteSpace = 'pre-line';
      tester.style.fontFamily = "'Patrick Hand', cursive";
      document.body.appendChild(tester);

      let fontSize = maxFontSize;
      const containerWidth = poemEl.clientWidth;
      const containerHeight = poemEl.clientHeight;
      const lines = text.split('\n');

      while (fontSize >= minFontSize) {
        tester.style.fontSize = fontSize + 'px';
        tester.innerText = text;

        const lineHeight = fontSize * 1.6;
        const totalHeight = lineHeight * lines.length;

        let maxLineWidth = 0;
        for (const line of lines) {
          tester.innerText = line;
          if (tester.scrollWidth > maxLineWidth) {
            maxLineWidth = tester.scrollWidth;
          }
        }

        if (maxLineWidth <= containerWidth && totalHeight <= containerHeight) {
          break;
        }
        fontSize--;
      }

      poemEl.style.fontSize = fontSize + 'px';
      document.body.removeChild(tester);
    }

    // --- Arka plan renk geçişi ---
    function randomSandColor() {
      const hue = 30 + Math.random() * 20; // 30–50 → sıcak kum
      const saturation = 25 + Math.random() * 20; // pastel
      const lightness = 85; // sabit koyuluk
      return {h: hue, s: saturation, l: lightness};
    }

    function hslToString({h, s, l}) {
      return `hsl(${h}, ${s}%, ${l}%)`;
    }

    async function animateBackground(duration) {
      const start = randomSandColor();
      const end = randomSandColor();

      const steps = 60;
      let currentStep = 0;

      return new Promise(resolve => {
        const interval = setInterval(() => {
          currentStep++;
          const t = currentStep / steps;
          const h = start.h + (end.h - start.h) * t;
          const s = start.s + (end.s - start.s) * t;
          const l = start.l; // sabit

          body.style.backgroundColor = hslToString({h, s, l});

          if (currentStep >= steps) {
            clearInterval(interval);
            resolve();
          }
        }, duration / steps);
      });
    }

    btn.addEventListener('click', async () => {
      if (btn.disabled) return;
      btn.disabled = true;
      hourglass.classList.add('spin');

      const bgAnim = animateBackground(2000);

      poemEl.classList.remove('visible');
      await sleep(2000);

      currentIndex++;
      if (currentIndex >= shuffledPoems.length) currentIndex = 0;
      const nextPoem = shuffledPoems[currentIndex];

      adjustFontSize(nextPoem);
      poemEl.innerText = nextPoem;
      setTimeout(() => poemEl.classList.add('visible'), 50);

      await bgAnim;
      btn.disabled = false;
      hourglass.classList.remove('spin');
    });

    window.onload = () => {
      shuffledPoems = shuffleArray(poems);
      currentIndex = -1;
      currentIndex++;
      const firstPoem = shuffledPoems[currentIndex];
      adjustFontSize(firstPoem);
      poemEl.innerText = firstPoem;
      setTimeout(() => poemEl.classList.add('visible'), 100);
    };
  </script>
</body>
</html>
